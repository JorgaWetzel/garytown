<# Remediation Script
This is a slimmed down version of the remediation script for CVE-2023-24932.  It only applies Step 1 & 2, which doesn't break any current processes
Step 3 is when the pain starts, so we'll leave that out for now.  You can get your fleet up to date with the first two steps, and then apply the third step when you're ready.

#>



#Includes Reboot Notifications 
#Test if Remediation is applicable
#Region Applicablitity
$CurrentOSInfo = Get-Item -Path 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion'
$Build = $CurrentOSInfo.GetValue('CurrentBuild')
[int]$UBR = $CurrentOSInfo.GetValue('UBR')

#April 2024 UBRs
$AprilPatch = @('19044.4291','19045.4291','22631.3447','22621.3447','22000.2899', '26100.1150')
$MatchedPatch = $AprilPatch | Where-Object {$_ -match $Build}
[int]$MatchedUBR = $MatchedPatch.split(".")[1]

if ($UBR -ge $MatchedUBR){
    $OSSupported = $true
}
else {
    $OSSupported = $false
}
#endregionApplicablitity

#Region Functions
function Set-PendingUpdate {
    # Set the registry key to indicate a pending update
    $RebootRequiredPath = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\WindowsUpdate\Auto Update\RebootRequired"
    if (-not (Test-Path $RebootRequiredPath)) {New-Item -Path $RebootRequiredPath -Force | Out-Null}
    # Create a value to indicate a pending update
    New-ItemProperty -Path $RebootRequiredPath -Name "UpdatePending" -Value 1 -PropertyType DWord -Force | Out-Null

    # Set the orchestrator key to 15
    $OrchestratorPath = "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\Orchestrator"
    New-ItemProperty -Path $OrchestratorPath -Name "ShutdownFlyoutOptions" -Value 10 -PropertyType DWord -Force | Out-Null
    New-ItemProperty -Path $OrchestratorPath -Name "EnhancedShutdownEnabled" -Value 1 -PropertyType DWord -Force | Out-Null

    $RebootDowntimePath = "HKLM:\SOFTWARE\Microsoft\WindowsUpdate\UX\RebootDowntime"
    New-ItemProperty -Path $RebootDowntimePath -Name "DowntimeEstimateHigh" -Value 1 -PropertyType DWord -Force | Out-Null
    New-ItemProperty -Path $RebootDowntimePath -Name "DowntimeEstimateLow" -Value 1 -PropertyType DWord -Force | Out-Null
}

#endregion Functions

if ($OSSupported -eq $true){
    $HPCMSLModule = (Get-InstalledModule -Name 'HPCMSL' -ErrorAction SilentlyContinue)
    if (($HPCMSLModule)){
        if ($HPCMSLModule.Version -lt 1.8.1){
            update-module -name HPCMSL -Force
        }
        $HPCMSL = $true
    }
    else {
        Install-Module -name 'HPCMSL' -AcceptLicense -SkipPublisherCheck -Force
    }
    
    if ($HPCMSL){
        #2Pint Logo
        $ToastBase64Image = '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'
        $logopath = "c:\programdata\toastlogo.png"
        $bytes = [Convert]::FromBase64String($ToastBase64Image)
        [IO.File]::WriteAllBytes($logopath , $bytes)

        $param = @{
            Title = 'Please Reboot'
            Message = "Secure Boot Changes Require a Reboot"
            LogoImage = $logopath
            TitleBarHeader = "2Pint Software"
            TitleBarIcon = $logopath
        }
    }

    $SecureBootRegPath = 'HKLM:\SYSTEM\CurrentControlSet\Control\SecureBoot'
    $RemediationRegPath = 'HKLM:\SOFTWARE\Remediation\KB5025885'
    if (-not (Test-Path -Path $RemediationRegPath)){
        New-Item -Path $RemediationRegPath -Force -ItemType Directory | Out-Null
    }
    $RebootCount = (Get-Item -Path $RemediationRegPath -ErrorAction SilentlyContinue).GetValue('RebootCount')
    if ($null -eq $RebootCount){
        $RebootCount = 0
    }
    
    #region Test if Remediation is already applied for each Step
    #Test: Applying the DB update
    $Step1Complete = [System.Text.Encoding]::ASCII.GetString((Get-SecureBootUEFI db).bytes) -match 'Windows UEFI CA 2023'
    
    #Test: Updating the boot manager
    $Volume = Get-Volume | Where-Object {$_.FileSystemType -eq "FAT32" -and $_.DriveType -eq "Fixed"}
    $SystemDisk = Get-Disk | Where-Object {$_.IsSystem -eq $true}
    $SystemPartition = Get-Partition -DiskNumber $SystemDisk.DiskNumber | Where-Object {$_.IsSystem -eq $true}  
    $SystemVolume = $Volume | Where-Object {$_.UniqueId -match $SystemPartition.Guid}
    $FilePath = "$($SystemVolume.Path)\EFI\Microsoft\Boot\bootmgfw.efi"
    $CertCollection = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2Collection
    $CertCollection.Import($FilePath, $null, 'DefaultKeySet')
    If ($CertCollection.Subject -like "*Windows UEFI CA 2023*") {$Step2Complete = $true}
    else {$Step2Complete = $false}
    
    #Test: Applying the DBX update
    #$Step3Complete = [System.Text.Encoding]::ASCII.GetString((Get-SecureBootUEFI dbx).bytes) -match 'Microsoft Windows Production PCA 2011'

    #endregion Test if Remediation is already applied for each Step

    #region Remediation
    if ($Step1Complete -eq $true -and $Step2Complete -eq $true -and $RebootCount -ne 3){
        Write-Output "The remediation is already applied."
    }

    else {
        Write-Output "The remediation is not applied."
        #Region Do Step 1 - #Applying the DB update
        if ($Step1Complete -ne $true){
            Write-Output "Applying the DB update"
            Write-Output "New-ItemProperty -Path $SecureBootRegPath -Name 'AvailableUpdates' -PropertyType dword -Value 0x40 -Force" 
            New-ItemProperty -Path $SecureBootRegPath -Name "AvailableUpdates" -PropertyType dword -Value 0x40 -Force
            New-ItemProperty -Path $RemediationRegPath -Name "RebootCount" -PropertyType dword -Value 1 -Force
            Suspend-BitLocker -MountPoint $env:SystemDrive -RebootCount 1
            Set-PendingUpdate
            if ($HPCMSL){Invoke-HPRebootNotification @param}
        }
        if ($Step1Complete -eq $true){
            if ($RebootCount -eq 1){
                New-ItemProperty -Path $RemediationRegPath -Name "RebootCount" -PropertyType dword -Value 2 -Force
                New-ItemProperty -Path $RemediationRegPath -Name  "Step1Success" -PropertyType dword -Value 1 -Force
                Set-PendingUpdate
                if ($HPCMSL){Invoke-HPRebootNotification @param}
            }
        }
        #endregion Do Step 1 - #Applying the DB update

        #region Do Step 2 - #Updating the boot manager
        if ($Step1Complete -eq $true -and $Step2Complete -ne $true){
            if ($RebootCount -eq 2){
                New-ItemProperty -Path $SecureBootRegPath -Name "AvailableUpdates" -PropertyType dword -Value 0x100 -Force
                New-ItemProperty -Path $RemediationRegPath -Name  "RebootCount" -PropertyType dword -Value 3 -Force
                Suspend-BitLocker -MountPoint $env:SystemDrive -RebootCount 1
                Set-PendingUpdate
                if ($HPCMSL){Invoke-HPRebootNotification @param}
            }
        }
        if ($Step2Complete -eq $true){
            if ($RebootCount -eq 3){
                New-ItemProperty -Path $RemediationRegPath -Name "RebootCount" -PropertyType dword -Value 4 -Force
                New-ItemProperty -Path $RemediationRegPath -Name  "Step2Success" -PropertyType dword -Value 1 -Force
                Set-PendingUpdate
                if ($HPCMSL){Invoke-HPRebootNotification @param}
            }
        }
        #endregion Do Step 2 - #Updating the boot manager


    }
    #endregion Remediation
    
} #Supported OS -eq $true
else {
    Write-Output "The OS is not supported for this remediation."
}
